<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Board - Noctem</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        body { background: #0d0d1a; overflow: hidden; }
        .board-layout { display: flex; height: 100vh; }
        
        /* Sidebar */
        .board-sidebar {
            width: 220px; background: #0a0a18; border-right: 1px solid #222;
            padding: 1rem; flex-shrink: 0; overflow-y: auto;
        }
        .board-sidebar .nav-links a { display: block; color: #6eb5ff; font-size: 0.8rem; margin-bottom: 0.3rem; }
        .board-sidebar h3 { font-size: 0.8rem; color: #888; margin-top: 1.5rem; margin-bottom: 0.5rem; }
        .board-sidebar .project-link {
            display: block; width: 100%; text-align: left; background: none; border: none;
            color: #e8e8e8; padding: 0.3rem 0.5rem; font-size: 0.8rem; cursor: pointer;
            border-radius: 4px; margin-bottom: 2px;
        }
        .board-sidebar .project-link:hover { background: #1a1a2e; color: #6eb5ff; }
        .board-sidebar .project-count { color: #555; font-size: 0.7rem; }
        
        /* Main area */
        .board-main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .board-header {
            padding: 0.75rem 1rem; border-bottom: 1px solid #222; background: #0a0a18;
            display: flex; align-items: center; gap: 1rem;
        }
        .board-header h1 { font-size: 1.2rem; margin: 0; }
        .board-header .board-stats { font-size: 0.8rem; color: #888; }
        
        /* Kanban columns */
        .board-columns {
            flex: 1; display: flex; gap: 1rem; padding: 1rem;
            overflow-x: auto; overflow-y: hidden; align-items: flex-start;
        }
        .kanban-col {
            min-width: 280px; max-width: 320px; flex-shrink: 0;
            background: #111128; border-radius: 8px; border: 1px solid #222;
            display: flex; flex-direction: column; max-height: calc(100vh - 100px);
        }
        .col-header {
            padding: 0.6rem 0.75rem; border-bottom: 1px solid #222;
            display: flex; justify-content: space-between; align-items: center;
        }
        .col-header .col-name { font-size: 0.85rem; font-weight: 600; }
        .col-header .col-count {
            font-size: 0.7rem; color: #555; background: #1a1a2e;
            padding: 1px 6px; border-radius: 10px;
        }
        
        /* AI summary in column */
        .col-summary {
            padding: 0.5rem 0.75rem; font-size: 0.7rem; color: #888;
            border-bottom: 1px solid #1a1a2e; background: rgba(110, 181, 255, 0.03);
        }
        .col-summary .ai-icon { color: #6eb5ff; margin-right: 4px; }
        
        /* Task cards */
        .col-tasks { flex: 1; overflow-y: auto; padding: 0.5rem; }
        .task-card {
            background: #1a1a2e; border: 1px solid #2a2a4e; border-radius: 6px;
            padding: 0.6rem; margin-bottom: 0.5rem; cursor: pointer;
            transition: border-color 0.15s;
        }
        .task-card:hover { border-color: #4a4a7c; }
        .task-card .card-title { font-size: 0.8rem; color: #e8e8e8; margin-bottom: 4px; }
        .task-card .card-meta { font-size: 0.7rem; color: #555; display: flex; gap: 0.5rem; }
        .task-card .card-priority {
            width: 4px; border-radius: 2px; flex-shrink: 0; margin-right: 4px;
        }
        .card-priority.p-high { background: #ff4757; }
        .card-priority.p-med { background: #ffa502; }
        .card-priority.p-low { background: #3a3a5c; }
        .task-card .card-due { color: #888; }
        .task-card .card-due.overdue { color: #ff4757; }
        
        /* Inbox column special */
        .kanban-col.inbox .col-header { border-bottom-color: #4a6fa5; }
        
        /* ===== SIDE PANEL (Notion-style) ===== */
        .side-panel {
            position: fixed; right: -420px; top: 0; width: 420px; height: 100vh;
            background: #12122a; border-left: 1px solid #222; z-index: 100;
            transition: right 0.25s ease; display: flex; flex-direction: column;
        }
        .side-panel.open { right: 0; }
        .side-panel-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.3); z-index: 99;
        }
        .side-panel-overlay.open { display: block; }
        
        .panel-header {
            padding: 1rem; border-bottom: 1px solid #222;
            display: flex; justify-content: space-between; align-items: flex-start;
        }
        .panel-close {
            background: none; border: none; color: #888; cursor: pointer;
            font-size: 1.2rem; padding: 0;
        }
        .panel-close:hover { color: #e8e8e8; }
        .panel-title { font-size: 1rem; font-weight: 600; color: #e8e8e8; flex: 1; }
        
        .panel-body { flex: 1; overflow-y: auto; padding: 1rem; }
        .panel-field { margin-bottom: 1rem; }
        .panel-field .field-label { font-size: 0.7rem; color: #555; text-transform: uppercase; margin-bottom: 0.25rem; }
        .panel-field .field-value { font-size: 0.85rem; color: #e8e8e8; }
        .panel-field .field-value.overdue { color: #ff4757; }
        .panel-field .field-value.empty { color: #333; font-style: italic; }
        
        .priority-indicator {
            display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 4px;
        }
        .priority-indicator.high { background: #ff4757; }
        .priority-indicator.medium { background: #ffa502; }
        .priority-indicator.low { background: #4ecca3; }
        
        .panel-section { margin-top: 1.5rem; }
        .panel-section h3 { font-size: 0.8rem; color: #888; margin-bottom: 0.5rem; border-bottom: 1px solid #222; padding-bottom: 0.3rem; }
        .panel-description { font-size: 0.8rem; color: #bbb; line-height: 1.5; }
    </style>
</head>
<body>
    <div class="board-layout">
        <!-- Sidebar -->
        <div class="board-sidebar">
            <div class="nav-links">
                <a href="/">‚Üê Dashboard</a>
                <a href="/calendar/view">Calendar</a>
                <a href="/tasks/upcoming">Upcoming Tasks</a>
                <a href="/tasks">Task Settings</a>
            </div>
            
            <h3>Projects</h3>
            <div id="projectList"></div>
        </div>
        
        <!-- Main board -->
        <div class="board-main">
            <div class="board-header">
                <h1>üìä Project Board</h1>
                <span class="board-stats" id="boardStats"></span>
            </div>
            <div class="board-columns" id="boardColumns"></div>
        </div>
    </div>
    
    <!-- Side panel overlay -->
    <div class="side-panel-overlay" id="panelOverlay" onclick="closePanel()"></div>
    
    <!-- Side panel -->
    <div class="side-panel" id="sidePanel">
        <div class="panel-header">
            <span class="panel-title" id="panelTitle"></span>
            <button class="panel-close" onclick="closePanel()">‚úï</button>
        </div>
        <div class="panel-body" id="panelBody"></div>
    </div>
    
    <script>
        let projectData = null;
        
        async function loadProjects() {
            const resp = await fetch('/api/tasks/projects');
            const raw = await resp.json();
            // Normalize: merge inbox into columns as a unified 'projects' array
            const projects = [];
            if (raw.inbox) projects.push({ name: raw.inbox.project_name || 'Inbox', tasks: raw.inbox.tasks || [], summary: null });
            if (raw.columns) {
                for (const col of raw.columns) {
                    projects.push({ name: col.project_name, tasks: col.tasks, summary: col.ai_summary });
                }
            }
            projectData = { projects };
            renderBoard();
            renderSidebar();
        }
        
        function renderSidebar() {
            if (!projectData || !projectData.projects) return;
            const el = document.getElementById('projectList');
            let html = '';
            for (const proj of projectData.projects) {
                html += `<button class="project-link" onclick="scrollToProject('${proj.name}')">
                    ${proj.name} <span class="project-count">${proj.tasks.length}</span>
                </button>`;
            }
            el.innerHTML = html;
        }
        
        function scrollToProject(name) {
            const col = document.querySelector(`.kanban-col[data-project="${name}"]`);
            if (col) col.scrollIntoView({ behavior: 'smooth', inline: 'center' });
        }
        
        function renderBoard() {
            if (!projectData || !projectData.projects) return;
            const columns = document.getElementById('boardColumns');
            let html = '';
            let totalTasks = 0;
            
            for (const proj of projectData.projects) {
                const isInbox = proj.name === 'Inbox';
                const colClass = isInbox ? ' inbox' : '';
                totalTasks += proj.tasks.length;
                
                html += `<div class="kanban-col${colClass}" data-project="${proj.name}">
                    <div class="col-header">
                        <span class="col-name">${isInbox ? 'üì• ' : 'üìÅ '}${proj.name}</span>
                        <span class="col-count">${proj.tasks.length}</span>
                    </div>`;
                
                // AI summary
                if (proj.summary) {
                    html += `<div class="col-summary"><span class="ai-icon">‚ú®</span>${proj.summary}</div>`;
                }
                
                html += '<div class="col-tasks">';
                
                // Sort by priority_score descending
                const sorted = [...proj.tasks].sort((a, b) => (b.priority_score || 0) - (a.priority_score || 0));
                
                for (const task of sorted) {
                    const score = task.priority_score || 0;
                    let pClass = 'p-low';
                    if (score >= 70) pClass = 'p-high';
                    else if (score >= 40) pClass = 'p-med';
                    
                    let dueHtml = '';
                    if (task.due_date) {
                        const isOverdue = new Date(task.due_date) < new Date(new Date().toDateString());
                        dueHtml = `<span class="card-due${isOverdue ? ' overdue' : ''}">${task.due_date}</span>`;
                    }
                    
                    html += `<div class="task-card" onclick='openPanel(${JSON.stringify(task).replace(/'/g, "&#39;")})'>
                        <div style="display:flex">
                            <div class="card-priority ${pClass}"></div>
                            <div>
                                <div class="card-title">${task.name || ''}</div>
                                <div class="card-meta">${dueHtml}</div>
                            </div>
                        </div>
                    </div>`;
                }
                
                if (proj.tasks.length === 0) {
                    html += '<div style="color:#333; font-size:0.75rem; padding:0.5rem; font-style:italic;">No tasks</div>';
                }
                
                html += '</div></div>';
            }
            
            columns.innerHTML = html;
            document.getElementById('boardStats').textContent = 
                `${projectData.projects.length} projects ¬∑ ${totalTasks} tasks`;
        }
        
        function openPanel(task) {
            const panel = document.getElementById('sidePanel');
            const overlay = document.getElementById('panelOverlay');
            
            document.getElementById('panelTitle').textContent = task.name || '';
            
            let body = '';
            
            // Properties grid
            const score = task.priority_score || 0;
            let priLabel = 'Low', priClass = 'low';
            if (score >= 70) { priLabel = 'High'; priClass = 'high'; }
            else if (score >= 40) { priLabel = 'Medium'; priClass = 'medium'; }
            
            body += `<div class="panel-field">
                <div class="field-label">Priority</div>
                <div class="field-value"><span class="priority-indicator ${priClass}"></span>${priLabel} (${score})</div>
            </div>`;
            
            body += `<div class="panel-field">
                <div class="field-label">Project</div>
                <div class="field-value">${task.project || '<span class="empty">None</span>'}</div>
            </div>`;
            
            if (task.due_date) {
                const isOverdue = new Date(task.due_date) < new Date(new Date().toDateString());
                body += `<div class="panel-field">
                    <div class="field-label">Due Date</div>
                    <div class="field-value${isOverdue ? ' overdue' : ''}">${task.due_date}${task.due_time ? ' at ' + task.due_time : ''}</div>
                </div>`;
            }
            
            if (task.labels && task.labels.length > 0) {
                body += `<div class="panel-field">
                    <div class="field-label">Labels</div>
                    <div class="field-value">${task.labels.join(', ')}</div>
                </div>`;
            }
            
            // Description section
            if (task.description) {
                body += `<div class="panel-section">
                    <h3>Description</h3>
                    <div class="panel-description">${task.description}</div>
                </div>`;
            }
            
            // Meta info
            body += `<div class="panel-section">
                <h3>Details</h3>`;
            if (task.id) body += `<div class="panel-field"><div class="field-label">Task ID</div><div class="field-value" style="font-family:monospace; font-size:0.75rem;">${task.id}</div></div>`;
            if (task.created_at) body += `<div class="panel-field"><div class="field-label">Created</div><div class="field-value">${task.created_at}</div></div>`;
            body += '</div>';
            
            document.getElementById('panelBody').innerHTML = body;
            panel.classList.add('open');
            overlay.classList.add('open');
        }
        
        function closePanel() {
            document.getElementById('sidePanel').classList.remove('open');
            document.getElementById('panelOverlay').classList.remove('open');
        }
        
        // Close panel on Escape
        document.addEventListener('keydown', e => { if (e.key === 'Escape') closePanel(); });
        
        loadProjects();
    </script>
</body>
</html>
